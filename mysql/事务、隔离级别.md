# 事务
事务的特性：原子性、一致性、隔离性、持久性

## SQL 标准的四种隔离级别：

|           隔离级别           | 脏读 | 不可重复读 | 幻读 |
| :--------------------------: | :--: | :--------: | :--: |
| read uncommitted（未提交读） |  √   |     √      |  √   |
|  read committed （提交读）   |  ×   |     √      |  √   |
| repeatable read （可重复读） |  x   |     x      |  √   |
|    serializable（串行化）    |  x   |     x      |  x   |


**脏写：**<font color="red">一个事务修改了另一个未提交事务修改过的数据，就意味着发生了脏写。</font>

![[MySQL 总结.assets/image-20200613130424577.png]]

**脏读：**<font color="red">一个事务读到了另一个未提交事务修改过的数据，意味着发生了脏读。</font>

![[MySQL 总结.assets/image-20200613130555190.png]]

**不可重复读：**<font color="red">一个事务只能读到另一个已经提交的事务修改过的数据，并且其他事务每对该数据进行一次修改并提交后，该事务都能查询得到最新值，意味着发生不可重复读。</font>

![[MySQL 总结.assets/image-20200613130725196.png]]

**幻读：**<font color="red">一个事务先根据某些条件查询出一些记录，之后另一个事务又向表中插入了符合这些条件的记录，原先的事务再次按照该条件查询时，能把另一个事务插入的记录也读出来，意味着发生了幻读。</font>

![[MySQL 总结.assets/image-20200613130901375.png]]

## 锁

### 一致性读（Consistent Reads）

事务利用 mvcc 进行读取的操作称为一致性读。所有的普通 select 语句在 `Read committed、repeatable read` 隔离级别下都算是一致性读。

一致性读并不会对表中的任何记录做加锁操作，其它事务可以自由的对表中的记录做改动。

### 锁定读（Locking Reads）

在读取记录时加 S 锁：

```
select ... lock in share mode;
```

在读取记录时加 X 锁：

```
select ... for update;
```

#### 共享锁（Shared Locks）

在事务要读取一条记录时，需要先获取该记录的 S（shared Locks） 锁。

#### 独占锁（Exclusive Locks）

在事务要改动一条记录时，需要先获取该记录的 X 锁。

#### 意向共享锁（Intention Shared Lock）

当事务准备在某条记录上加 S 锁时，需要现在表级别加一个 IS 锁。

#### 意向独占锁（Intention Exclusive Lock）

当事务准备在某条记录上加 X 锁时，需要先在表级别加一个 IX 锁。

<font color="red">IS、IX 锁是表级锁，它们的提出仅仅为了在之后加表级别的 S 锁和 X 锁时可以快速判断表中的记录是否被上锁，以避免用遍历的方式来查看表中有没有上锁的记录，就是说 IS 和 IX 锁时兼容的，IX 和 IX 锁是兼容的。</font>



