---
tags: []
date created: 2022-03-30 04:09
date modified: 2023-04-04 02:34
title: 锁
---

# 锁

## 全局锁

对整个数据库加锁，多用于全库备份
命令：`flush tables with read lock`
该命令会导致 DDL，DML 语句不能生效，可以使用 mysqldump 参数 --single-transaction，启动事务，拿到一致性视图
释放全局锁：`unlock tables`

## 表级锁

指定一个表加读或写锁
命令：`lock tables ... read/write`

## 行锁

### 记录锁

`select * from t where id = 1 for update`
在 id=1 的记录上加行锁，阻止其他事务插入、更新、删除该行

### Gap Lock（间隙锁）

间隙锁，只存在于可重复读隔离级别，是为了解决可重复读隔离级别下幻读的现象
![](attachments/Pasted%20image%2020230404020853.png)
间隙锁之间时兼容的，即两个事务可以同时持有包含共同间隙范围的间隙锁，并不存在互斥关系，因为间隙锁是为了防止插入幻影记录而提出的。

### Next-Key Lock

Next-Key，是包含间隙锁 + 记录锁的，在可重复读级别下生效，它的范围包含索引记录和索引区间，是一个左开右闭区间。

在非唯一索引列上都会存在 next-key，在唯一索引（主键索引）上不存在 next-key。
