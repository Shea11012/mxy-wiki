---
date created: 2022-04-17 03:47
date modified: 2022-04-19 04:26
title: 主从复制
---
## 主从复制原理
分为三个阶段：建立连接、数据同步、命令传播
主从复制的核心阶段是数据同步阶段，根据主从节点当前状态的不同，分为：
- 全量复制
- 部分复制

### 数据同步
#### 全量复制
用于初次复制或其他无法进行部分复制的情况
redis 使用 psync 命令进行全量复制，过程：
1. 从节点判断无法进行部分复制后，向主节点发送全量复制的请求，或者从节点发送部分复制请求，主节点判断无法进行部分复制
2. 主节点收到全量复制命令后，执行 bgsave，生成 RDB 文件，并使用一个**复制缓冲区**记录从现在开始执行的所有写命令
3. 主节点的 bgsave 执行完成后，将 RDB 文件发送给从节点，从节点清除自己的旧数据，然后载入新接收的 RDB 文件
4. 主节点再将复制缓冲区中的所有写命令发送给从节点，从节点执行这些写命令
5. 如果从节点开启 AOF，则触发 bgrewriteaof，从而保证 AOF 文件更新至主节点的最新状态

#### 部分复制
用于网络中断等情况后的复制，只将中断期间主节点执行的写命令发送给从节点；如果网络中断时间过长，导致主节点没有能够完整保存中断期间执行的写命令，则无法进行部分复制，就会使用全量复制

##### 复制偏移量
主节点和从节点分别维护一个复制偏移量，代表主节点向从节点传递的字节数。主节点每次向从节点传播 N 个字节数据时，主节点 offset 增加 N；从节点每次接收到主节点传来的 N 个字节数据时，从节点 offset 增加 N。

通过 offset 判断主从节点状态是否一致

##### 复制积压缓冲区
复制积压缓冲区是由主节点维护的、固定长度、先进先出队列，默认 1MB。当主节点开始有从节点时创建，作用是备份主节点最近发送给从节点的数据。**无论主节点有多少个从节点，都只需要一个复制积压缓冲区**

在命令传播节点，主节点除了将写命令发送给从节点，还会发送一份给复制积压缓冲区，作为写命令的备份。除了存储写命令，复制积压缓冲区还存储了其中每个字节对应的复制偏移量。

由于该缓冲区长度固定且有限，所以当主从节点 offset 差距过大超过缓冲区长度时，将无法执行部分复制，只能执行全量复制

从节点将 offset 发送给主节点后，主节点根据 offset 和缓冲区大小决定是否能执行部分复制

##### 服务器运行 ID
每个 redis 节点，在启动时都会自动生成一个随机 ID
主从节点初次复制时，主节点将自己的 runid 发送给从节点，从节点保存该 runid。当断线重连时，从节点发送 runid 和 offset，主节点根据 runid 和 offset 进行判断是否能执行部分复制。
