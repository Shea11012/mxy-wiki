---
tags: []
date created: 2023-03-27 15:38
date modified: 2023-03-28 00:11
---

## CPU 使用率

CPU 使用率，是除了空闲时间外的其他时间占总 CPU 时间的百分比，包含：用户 CPU、系统 CPU、iowait、硬中断、软中断等。

### 相关工具

#### top

默认统计最近 3 秒的平均值
>[!info]
>us，un-niced 的进程的 CPU 使用率
>ni，被调整过 nice 值的进程 CPU 使用率
>wa，iowait

#### mpstat

显示所有 CPU 的指标，每个一秒输出
```shell
mpstat -P ALL 1
```
>[!info]
>%usr，用户进程使用的 CPU 时间，包含 un-niced 和 niced
>%nice，niced 进程 CPU 使用时间

#### pidstat

显示所有进程的 CPU 指标，每秒输出一次
```shell
pidstate -u 1
```
>[!info]
>%wait 表示任务等待运行时所占用的 CPU 百分比

#### perf

实时显示占用 CPU 时钟最多的函数或指令

### 调优技巧

- us cpu 占用过高，说明用户态进程占用了较多的 CPU，着重排查程序本身的代码逻辑
- sy cpu 占用过高，说明内核态代码占用较多的 cpu，着重排查内核线程或系统调用
- wa cpu 占用过高，说明等待 I/O 完成所花的时间比较长，着重排查 linux 系统是否存在 IO 相关的性能瓶颈
- hi 和 si 占用过高，说明软中断或硬中断处理程序占用较多的 CPU，着重排查内核中的中断服务程序，一般是网络
- 系统整体 CPU 较高，而实际的单个进程 CPU 使用都不高，考虑短时进程是否被频繁创建和销毁

## 平均负载

平均负载是指单位时间内，系统处于可运行状态（running）和不可中断等待状态（uninterruptible）的平均进程数

### 相关工具

- uptime
- top
- dstat -y

### 调优技巧

- 平均负载高可能是 CPU 密集型进程导致
- 平均负载高不一定代表 CPU 使用率高，可能是等待 IO 进程变多了

## 上下文切换

### 相关工具

#### vmstat

- cs 列：系统每秒上下文切换次数
- r 列：处于可运行状态的进程数量
- b 列：处于不可中断睡眠状态的数量

#### pidstat

显示进程每秒自愿和非自愿上下文切换次数
```shell
pidstat -w
```
- cswch/s：进程每秒自愿切换上下文的总数
- nvcswch/s：进程每秒非自愿上下文切换的总数

#### /proc/interrupts

#### /proc/softirqs

### 调优技巧

- 进程自愿上下文切换多了，表示进程在等待资源
- 进程非自愿上下文切换多了，说明进程在被强制调度（被实时性更高的进程抢占）
- 中断次数多了，说明中断处理程序在占用大量的 CPU
- 软中断次数多了，说明下半部处理程序占用大量 CPU，一般是网络

