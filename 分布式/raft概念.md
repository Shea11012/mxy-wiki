---
tags:
  - raft
date created: 2024-01-27 02:04
date modified: 2024-01-28 06:21
---

# 背景

raft 是一种共识算法。
当数据增长到单机处理的瓶颈时，此时需要将数据进行分片（shard）分散存储到多个机器上。同时为了容忍机器故障、保证分片的可用性，通常会将分片冗余存储，每个冗余被称为副本（replication）。
当某个分片持续写入，对应分片的多个副本，可能由于机器故障、网络问题，出现数据不一致的问题。为了保证多副本间数据一致，引入了共识算法。

# 基本原理

raft 会将客户端请求序列化，称为**操作日志（operation log）**，确保每个 raft 实力看到相同的日志。一个 raft 实例会有包含多个分片的**状态机**，不同机器上的一个分片下副本组成一个 raft group。
所有 raft 实例初始状态为空，会按照相同顺序执行相同客户端请求，从而保证状态机一致。如果某个机器宕机重启后，进度落下，raft 算法会负责将其日志追平。**只要超过半数的机器存活并且可以互相通信，raft 就可以继续正常运行**，如果当前没有多数派存活，raft 会陷入停滞，不接受外来请求，一旦多数派重新可以互通，则可以继续工作。

[raft扩展论文](https://raft.github.io/raft.pdf) 在代码级别定义了所需要的数据结构和每个 RPC 的行为细节。
![[../assets/分布式/raft概念/IMG-20240127054655973.png]]

# 任期（term）

raft 中所有关键事件都是基于任期。
在 raft 中，如果出现网络分区，某些机器被隔绝，一旦重新与其他机器建立通信，首要做的就是对齐 term。
- 低任期的机器收到高任期的通信，会自动变为 Follower
- 高任期收到低任期请求时，会直接拒绝

# Leader 选举

leader 对其任期内日志有绝对的权威。一个任期内最多只能有一个 leader。在同一时刻，可能会存在多个 leader，但他们一定处于不同任期。
每个实例在投票时，都会比对谁的日志更全，一旦投出票，则会承诺一段时间内不会再发起选举（重置选举时钟）。
leader 当选后，会定时发出心跳。followers 收到心跳，只要 term 不比 leader 大，就要继续重置选举时钟。

# 日志同步

leader 在收到客户端请求后，会将日志附带到心跳上广播出去。如果 leader 日志量很大，通信代价会非常高。因此 leader 采用“乐观 + 回溯”的方式进行同步。
- 乐观：一开始心跳不附带任何日志，会通过二元组 `(日志索引、任期)`，如果 follower 发现日志与 leader 一致，则不需要附加日志
- 回溯：当不一致时，会附带一些日志，并更新二元组，直到 follower 回复一致，则恢复不带日志的心跳

回溯的过程是一个递推过程，通过一个一个的往前推，找到共同的日志，往后同步
。
# 参考

- [可视化raft](http://thesecretlivesofdata.com/raft/)
