---
tags:
  - go
date created: 2022-03-26 14:49
date modified: 2023-05-20 06:01
title: 内存管理
go version: 1.2
---

# Go 的内存管理运行时组件

- 从操作系统申请内存，由页分配器（Page Allocator）负责
- 为用户程序分配内存，由对象分配器（Object Allocator）负责
- 回收用户程序所分配内存，由垃圾回收器（Garbage Collector）负责
- 向操作系统归还申请内存，由拾荒器（Scavenger）负责

# Go 堆栈与传统堆栈的区别

传统意义的栈由 Go 运行时控制，不开放给用户态代码
传统意义的堆由 Go 运行时划分为两部分：
- 一个是 Go 运行时自身所需的堆内存，用 `sys.NotInHeap` 标记，显示区分分配在 mheap 上的内存
- 另一个则用于 Go 用户态代码所使用的堆内存，负责用户态对象和 goroutine 的执行栈

从页分配器的视角看，堆是按照连续的页（page）进行管理，每次对堆内存进行增长时都是以页为单位进行的，页的大小为 8KB

从对象分配器看，每次需要为程序的对象分配内存时，都是以跨度（span）进行管理。一个跨度以 mspan 结构进行存储，每个跨度可以存储多个分配的对象，并由多个连续的页组成。

# 内存分配策略

分配机制可以分为两类：
- 顺序分配（sequential allocator）
- 空闲链表分配（free-list allocator）

在用户程序中，堆内存中的对象本身都是存放在跨度上，因此对象分配器便是以如何从堆中分配跨度进行。对象分配的缓存分为两个：
- 本地跨度缓存：不需要分配新的跨度。对象可以直接在 goroutine 所在的线程中某个现有的跨度缓存中获取
- 中心跨度缓存：需要分配新的跨度。当需要一个新的跨度来存放对象，当线程的跨度缓存已经没有可用跨度时，会尝试从中心跨度缓存获取可用跨度。

## mspan 跨度

Go 内存管理的基本单元 mspan，它是一个双向链表分别指向了前后的 mspan。每个 mspan 都由一连串的页组成。

mspan 中的跨度类，决定了内存管理单元中存储的对象大小和个数，Go 中一共包含 67 个跨度类。`runtime.class_to_size` 和 `runtime.class_to_allocnpages` 变量中
每种跨度都有两种类型：
- scan：包含指针类型
- noscan：不包含指针类型

在进行 GC 时，时只需要扫描 scan 类型即可

## mcache 线程缓存

mcache 由 P 持有，如果 G 需要内存可以直接从 mcache 中获取，由于在同一时间只有一个 G 运行在 P 上，所以中间不需要任何锁参与。

mcache 包含所有跨度种类的 mspan 作为缓存

## mcentral 中心缓存

访问 mcentral 时需要使用互斥锁
每个 mcentral 都会管理某个跨度类的 mspan，分别存储包含空闲对象和不包含空闲对象的内存管理单元

# 对象分配

`runtime.mallocgc` 是对象分配器的核心入口

Go 语言的内存分配器会根据申请分配的内存大小选择不同的处理逻辑，运行时根据对象的大小将对象分为微对象、小对象和大对象：
- 微对象：0 ~ 16B，先使用微分配器，再依次尝试线程缓存、中心缓存和堆内存分配
- 小对象：16B ~ 32KB，依次尝试线程缓存、中心缓存和堆内存分配
- 大对象：32KB ~ ，直接进行堆内存分配

>[!note] 微分配器
>微分配器只会用于分配非指针类型的内存
>
>将多个较小的内存分配请求合入同一个内存块中，只有当该内存块中的所有对象都需要被回收时，整片内存才可能被回收。

# 页分配器

`mheap.alloc` 是页分配器的入口

页分配器的核心功能：
- 在堆地址空间足够时，通过 `h.pages.alloc(npages)` 获取初始地址
- 在堆地址空间不够时，通过 `h.grow(npages)` 增长可用地址空间

# 栈内存管理

Go 的程序都是运行在 goroutine 上，所以这里说的栈即 goroutine 的执行栈

Go 使用过两个栈分配机制：
- ~~分段栈~~ ：能按需分配内存并且减少内存占用，但因为扩缩容对栈的分配和释放会造成巨大的额外开销
- 连续栈：当栈发生扩容，会新建一个 2 倍大小的新栈，将旧栈复制到新栈上

# arena

Go 中的虚拟内存布局由一组 arena 组成，初始堆隐射是一个 arena，即 64MB。根据程序需要，内存以一个较小的增量进行映射，并且以一个 arena 开始。这个 arena 就是所谓的堆，Go 以 8KB 大小粒度的页面管理每个 arena。
Go 在 arena 中还有两个 span 和 bitmap，它们都在堆外分配，并存储着每个 arena 的元数据。它们主要在垃圾收集期间使用。