---
date created: 2022-04-15 18:55
date modified: 2022-04-19 01:16
title: 主从复制
---
## 复制的优点
- 主库出现问题，可以快速切换到从库
- 从库执行查询操作，降低主库访问压力
- 使用从库进行备份，以免备份期间影响到主库的服务

## 主从复制原理
主从复制涉及到三个线程，一个运行在主节点（log dump thread），其余两个（IO thread，SQL thread）运行在从节点

![[Pasted image 20220415190058.png]]

### 主节点 log dump 线程
当从节点连接主节点时，主节点会为其创建一个 log dump 线程，用于发送和读取 bin-log 的内容。在读取 bin-log 时会对主节点上的 bin-log 加锁，当读取完成，发送给从节点之前，锁会被释放。主节点会为自己的每一个从节点创建一个 log dump 线程

### 从节点 IO 线程
当从节点上执行 `start slave` 命令后，从节点会创建一个 IO 线程用来连接主节点，请求主库中的 bin-log。IO 线程收到主节点的 log dump 进程发来的更新之后，保存在本地 relay-log 日志中

### 从节点 SQL 线程
SQL 线程负责读取 relay-log 中的内容，解析成具体的操作并执行，最终保证主从数据的一致性。
从节点用两个线程从主库拉取更新和执行分成独立的任务，这样在执行同步数据任务的时候，不会降低读操作的性能

![](attachments/Pasted%20image%2020220419011508.png)

5.6 版本之后，将 SQL 线程变为一个只负责读取日志和分发事务的线程，真正的更新变为了 workers 线程，分发事务时需要满足两个条件：
- 不能造成更新覆盖，要求更新同一行的两个事务，必须被分发到同一个 worker 中
- 同一个事务不能被拆开，必须放到同一个 worker 中

## 复制模式
异步模式是 MySQL 主从复制的默认模式。
### 异步模式
这种模式下，主节点不会主动推送 bin-log 到从节点，主库在执行客户端提交的事务后会立即将结果返回给客户端，并不关心从库是否接受并处理。这样当主节点崩溃掉后，主节点上已提交的事务可能并没有传到从节点上，此时将从节点提升为主，可能导致主节点上的数据不完整。

### 半同步模式
主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接受到并写到 relay-log 中才返回成功信息给客户端，否则等到超时时间然后切换成异步模式再提交。

### 全同步模式
当主库执行完一个事务，然后所有的从库都复制了该事务并成功执行完才返回成功信息给客户端。因为需要等待所有从库执行完该事务才能返回成功信息，所以全同步复制的性能会受到严重的影响。

### GTID 复制模式
GTID（global transaction identifier）全局事务 ID，保证每个在主库上提价的事务在集群中有一个唯一 ID

#### GTID 复制原理
GTID=server_id:transaction_id，server_id 在数据库启动过程中自动生成，server_id 存放在数据目录的 auto.conf 中，transaction_id 则是事务执行时由 MySQL 自动分配的一个递增序列号

GTID 复制，从库会告知主库已经执行的事务 GTID 值，然后主库会将所有未执行的事务 GTID 列表返回给从库，并且可以保证同一个事务只在指定的从库执行一次（通过全局的事务 ID 确定从库要执行的事务方式代替了以前需要用 bin-log 和 pos 点确定从库要执行的事务方式）

主节点更新数据时，会在事务前产生 GTID，一起记录到 bin-log 中。从节点的 IO 线程将变更的 bin-log，写入到本地的 relay-log 中。SQL 线程从 relay-log 中获取 GTID，然后对比本地 bin-log 是否有记录。如果有记录，说明该 GTID 事务已经执行，从节点忽略。如果没有记录，从节点就会从 relay-log 中执行该 GTID 事务，并记录到 bin-log

#### GTID 复制局限性
- 不能使用 `create table table_name`,`select * from table_name` 模式的语句
- 在一个事务中既包含事务表的操作又包含非事务表
- 不支持 `create temporary table` 或 `drop temporary table`
- GTID 复制从库跳过操作时，不支持 sql_slave_skip_counter 参数


## 复制形式
一主一从和一主多从，提高系统的读性能，读写分离，提高系统的并发能力
### 一主一从
![[Pasted image 20220415191152.png]]

### 一主多从
![[Pasted image 20220415191444.png]]


### 多主一从
将多个数据库备份到一台存储性能比较好的服务器上

![[Pasted image 20220415191555.png]]

### 级联复制
部分 slave 数据同步不连接主节点，而是连接从节点。因为如果主节点有太多的从节点，就会损耗一部分性能用于复制，让 3-5 个从节点连接主节点，其它从节点作为二级或者三级从节点连接，这样可以缓解主节点的压力，并且对数据一致性没有负面影响。

![[Pasted image 20220415191811.png]]

### 主主
互做主从复制，这样任何一方所做的变更，都会通过复制应用到另外一方的数据库中。

![[Pasted image 20220415191922.png]]